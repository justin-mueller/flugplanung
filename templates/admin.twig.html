<div class="card mt-3">
    <div class="card-header">
        <h5 class="card-title mb-0">
            <i class="fa-solid fa-envelope me-2"></i>Newsletter / E-Mails senden
        </h5>
    </div>
    <div class="card-body">
        
        <!-- Test Recipient Selection -->
        <div class="row mb-4">
            <div class="col-md-6">
                <label for="test-recipient" class="form-label fw-semibold">Test-Empfänger E-Mail</label>
                <input type="email" id="test-recipient" class="form-control" value="{{ currentUserEmail }}" placeholder="E-Mail-Adresse eingeben">
                <small class="text-muted">Gebe eine E-Mail-Adresse für Test-E-Mails ein</small>
            </div>
        </div>

        <!-- User ID Range Limit -->
        <div class="row mb-4">
            <div class="col-md-6">
                <label class="form-label fw-semibold">Begrenzen auf User-ID Bereich</label>
                <div class="row g-2">
                    <div class="col-6">
                        <div class="input-group">
                            <span class="input-group-text">Von</span>
                            <input type="number" id="user-id-from" class="form-control" value="0" min="0">
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="input-group">
                            <span class="input-group-text">Bis</span>
                            <input type="number" id="user-id-to" class="form-control" value="99999" min="0">
                        </div>
                    </div>
                </div>
                <small class="text-muted">Nur Empfänger mit User-ID in diesem Bereich erhalten die E-Mail</small>
            </div>
        </div>

        <!-- Internal Club Filter -->
        <div class="row mb-4">
            <div class="col-md-6">
                <label class="form-label fw-semibold">Auf Vereinsmitglieder begrenzen</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="internal-only" value="1">
                    <label class="form-check-label" for="internal-only">
                        Nur an interne Vereinsmitglieder senden
                    </label>
                </div>
                <small class="text-muted" id="club-filter-preview">Nur an Mitglieder von <strong>{{ clubName }} ({{ clubId }})</strong> senden</small>
            </div>
        </div>

        <hr class="my-4">

        <!-- Mail List -->
        <h6 class="fw-semibold mb-3">Verfügbare E-Mail-Vorlagen</h6>
        <div id="mail-list" class="mb-4">
            <div class="text-muted">
                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                E-Mails werden geladen...
            </div>
        </div>

    </div>
</div>

<!-- Mail Preview Modal -->
<div class="modal fade" id="mailPreviewModal" tabindex="-1" aria-labelledby="mailPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mailPreviewModalLabel">E-Mail Vorschau</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body p-0">
                <iframe id="mail-preview-iframe" style="width: 100%; height: 500px; border: none;"></iframe>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Send Modal -->
<div class="modal fade" id="confirmSendModal" tabindex="-1" aria-labelledby="confirmSendModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmSendModalLabel">
                    <i class="fa-solid fa-exclamation-triangle me-2"></i>Bestätigung erforderlich
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <p>Du bist dabei, die E-Mail <strong id="confirm-mail-subject"></strong> an <strong>alle Newsletter-Abonnenten</strong> zu senden.</p>
                <p class="mb-3">Gebe zur Bestätigung ein:</p>
                <input type="text" id="confirm-phrase-input" class="form-control" 
                    placeholder="ja ich bin mir sicher"
                    autocomplete="off">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                <button type="button" class="btn btn-danger" id="confirm-send-btn">
                    <i class="fa-solid fa-paper-plane me-1"></i>Senden
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1" aria-labelledby="logsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="logsModalLabel">Versand-Protokolle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Schließen"></button>
            </div>
            <div class="modal-body">
                <div id="logs-list">
                    <div class="text-muted">
                        <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                        Logs werden geladen...
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    const SECRET_KEY = '{{ newsletterSecret }}';
    let mailsData = [];
    let pendingMailFilename = null;
    let pendingMailWrapper = null;

    // Load admin data on init
    function loadAdminData() {
        fetch('getAdminData.php')
            .then(response => response.json())
            .then(data => {
                mailsData = data.mails || [];
                renderMailList();
            })
            .catch(error => {
                console.error('Error loading admin data:', error);
                document.getElementById('mail-list').innerHTML = 
                    '<div class="alert alert-danger">Fehler beim Laden der Daten</div>';
            });
    }

    // Render mail list
    function renderMailList() {
        const container = document.getElementById('mail-list');
        
        if (mailsData.length === 0) {
            container.innerHTML = '<div class="alert alert-info">Keine E-Mail-Vorlagen im Ordner "mails" gefunden.</div>';
            return;
        }

        let html = '<div class="table-responsive"><table class="table table-hover align-middle mb-0">';
        html += '<thead class="table-light"><tr>';
        html += '<th>Betreff</th>';
        html += '<th>Datei</th>';
        html += '<th style=\"width: 200px;\">Absender</th>';
        html += '<th style="width: 80px;" class="text-center">Test</th>';
        html += '<th style="width: 80px;" class="text-center">Senden</th>';
        html += '<th style="width: 80px;" class="text-center">Vorschau</th>';
        html += '<th style="width: 80px;" class="text-center">Logs</th>';
        html += '</tr></thead><tbody>';

        mailsData.forEach(mail => {
            html += '<tr>';
            html += `<td class="fw-semibold">${escapeHtml(mail.subject)}</td>`;
            html += `<td class="text-muted small">${escapeHtml(mail.filename)}</td>`;            
            // Add sender address
            html += `<td class="text-muted small">${escapeHtml(mail.sender)}</td>`;
                        html += `<td class="text-center">
                <div class="form-check d-flex justify-content-center mb-0">
                    <input class="form-check-input test-checkbox" type="checkbox" data-filename="${escapeHtml(mail.filename)}" id="test-${escapeHtml(mail.filename)}" checked>
                </div>
            </td>`;
            html += `<td class="text-center">
                <button type="button" class="btn btn-sm btn-primary send-btn" data-filename="${escapeHtml(mail.filename)}" data-subject="${escapeHtml(mail.subject)}" data-wrapper="${escapeHtml(mail.wrapper)}">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </td>`;
            html += `<td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-secondary preview-btn" data-filename="${escapeHtml(mail.filename)}">
                    <i class="fa-solid fa-eye"></i>
                </button>
            </td>`;
            html += `<td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-info logs-btn" data-filename="${escapeHtml(mail.filename)}">
                    <i class="fa-solid fa-file-lines"></i>
                </button>
            </td>`;
            html += '</tr>';
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;

        // Attach event listeners
        attachEventListeners();
    }

    // Attach event listeners
    function attachEventListeners() {
        // Send buttons
        document.querySelectorAll('.send-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filename = this.dataset.filename;
                const subject = this.dataset.subject;
                const wrapper = this.dataset.wrapper;
                const testCheckbox = document.querySelector(`.test-checkbox[data-filename="${filename}"]`);
                const isTest = testCheckbox ? testCheckbox.checked : true;
                const testRecipient = document.getElementById('test-recipient').value;

                if (isTest) {
                    if (!testRecipient) {
                        alert('Bitte gebe eine Test-E-Mail-Adresse ein.');
                        return;
                    }
                    sendMail(filename, true, testRecipient, wrapper);
                } else {
                    // Show confirmation modal for sending to all
                    showConfirmModal(filename, subject, wrapper);
                }
            });
        });

        // Preview buttons
        document.querySelectorAll('.preview-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filename = this.dataset.filename;
                showPreview(filename);
            });
        });

        // Logs buttons
        document.querySelectorAll('.logs-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const filename = this.dataset.filename;
                showLogs(filename);
            });
        });
    }

    // Show confirmation modal
    function showConfirmModal(filename, subject, wrapper) {
        pendingMailFilename = filename;
        pendingMailWrapper = wrapper;
        document.getElementById('confirm-mail-subject').textContent = subject;
        document.getElementById('confirm-phrase-input').value = '';
        const modal = new bootstrap.Modal(document.getElementById('confirmSendModal'));
        modal.show();
    }

    // Send mail
    function sendMail(filename, isTest, testRecipient, wrapper) {
        const formData = new FormData();
        formData.append('mail_file', filename);
        if (isTest && testRecipient) {
            formData.append('test_recipient', testRecipient);
        }

        const testParam = isTest ? 'true' : 'false';
        const wrapperFile = wrapper || 'sendMail.php';
        const url = `${wrapperFile}?key=${SECRET_KEY}&test=${testParam}`;

        // Open in new window to show result
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = url;
        form.target = '_blank';

        const mailInput = document.createElement('input');
        mailInput.type = 'hidden';
        mailInput.name = 'mail_file';
        mailInput.value = filename;
        form.appendChild(mailInput);

        if (isTest && testRecipient) {
            const recipientInput = document.createElement('input');
            recipientInput.type = 'hidden';
            recipientInput.name = 'test_recipient';
            recipientInput.value = testRecipient;
            form.appendChild(recipientInput);
        }

        // Add user ID range parameters
        const userIdFrom = document.getElementById('user-id-from').value;
        const userIdTo = document.getElementById('user-id-to').value;
        
        const fromInput = document.createElement('input');
        fromInput.type = 'hidden';
        fromInput.name = 'user_id_from';
        fromInput.value = userIdFrom;
        form.appendChild(fromInput);

        const toInput = document.createElement('input');
        toInput.type = 'hidden';
        toInput.name = 'user_id_to';
        toInput.value = userIdTo;
        form.appendChild(toInput);

        // Add internal only parameter
        const internalOnly = document.getElementById('internal-only').checked;
        if (internalOnly) {
            const internalInput = document.createElement('input');
            internalInput.type = 'hidden';
            internalInput.name = 'internal_only';
            internalInput.value = '1';
            form.appendChild(internalInput);
        }

        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    }

    // Show preview modal
    function showPreview(filename) {
        const modal = new bootstrap.Modal(document.getElementById('mailPreviewModal'));
        const iframe = document.getElementById('mail-preview-iframe');
        iframe.src = 'getMailContent.php?file=' + encodeURIComponent(filename);
        modal.show();
    }

    // Show logs modal
    function showLogs(filename) {
        fetch('getMailLogs.php?mail_file=' + encodeURIComponent(filename))
            .then(response => response.json())
            .then(data => {
                displayLogsModal(filename, data.logs || []);
            })
            .catch(error => {
                console.error('Error loading logs:', error);
                alert('Fehler beim Laden der Logs');
            });
    }

    // Display logs in modal
    function displayLogsModal(mailFile, logs) {
        const modal = new bootstrap.Modal(document.getElementById('logsModal'));
        const logsContainer = document.getElementById('logs-list');
        
        document.getElementById('logsModalLabel').textContent = 'Versand-Protokolle: ' + mailFile;
        
        if (logs.length === 0) {
            logsContainer.innerHTML = '<div class="alert alert-info">Keine Logs für diese E-Mail-Vorlage gefunden.</div>';
        } else {
            let html = '<div class="list-group">';
            logs.forEach(log => {
                const badge = log.is_test ? '<span class="badge bg-warning text-dark ms-2">TEST</span>' : '';
                html += `<a href="mails/mail_logs/${encodeURIComponent(log.filename)}" target="_blank" class="list-group-item list-group-item-action">
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div>
                            <i class="fa-solid fa-file-lines me-2 text-primary"></i>
                            <strong>${escapeHtml(log.readable_date)}</strong>
                            ${badge}
                        </div>
                        <small class="text-muted">${formatFileSize(log.file_size)}</small>
                    </div>
                </a>`;
            });
            html += '</div>';
            logsContainer.innerHTML = html;
        }
        
        modal.show();
    }

    // Format file size
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Confirm send button handler
    document.getElementById('confirm-send-btn').addEventListener('click', function() {
        const phrase = document.getElementById('confirm-phrase-input').value;
        
        if (phrase !== 'ja ich bin mir sicher') {
            alert('Bitte gebe "ja ich bin mir sicher" ein.');
            return;
        }

        if (pendingMailFilename) {
            sendMail(pendingMailFilename, false, null, pendingMailWrapper);
            bootstrap.Modal.getInstance(document.getElementById('confirmSendModal')).hide();
            pendingMailFilename = null;
            pendingMailWrapper = null;
        }
    });

    // Escape HTML helper
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize
    loadAdminData();
})();
</script>